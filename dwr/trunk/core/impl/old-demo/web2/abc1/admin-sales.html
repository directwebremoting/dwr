<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
  <title>Air-Band Configurator</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1"/>
  <link rel="stylesheet" type="text/css" href="global/generic.css"/>
  <!-- <script type="text/javascript" src="global/calendarDateInput.js"></script> -->
  <script type='text/javascript' src='dwr/interface/Actions.js'></script>
  <script type='text/javascript' src='dwr/engine.js'></script>
  <script type='text/javascript' src='dwr/util.js'></script>
  <script type='text/javascript' src='global/windows.js'></script>
  <script type="text/javascript" src="global/generic.js"></script>
  <script>
    var getCustomerName = function(sale) { return sale.custname };
    var getServiceName = function(sale) { return sale.servname };
    var getEdit = function(sale)
    {
        return "<input onclick=\"readSale(" + sale.saleid + ")\" type='button' value='Edit'/>";
    };
    var getDelete = function(sale)
    {
        return "<input onclick=\"deleteSale(" + sale.saleid + ")\" type='button' value='Delete'/>";
    };
    var getAddPayment = function(sale)
    {
        return "<input onclick=\"addPayment(" + sale.saleid + ")\" type='button' value='Add Payment'/>";
    };

    function fillTable(people)
    {
        DWRUtil.removeAllRows("sales");
        DWRUtil.addRows("sales", people, [ getCustomerName, getServiceName, getEdit, getDelete, getAddPayment ])
    }

    function readSale(servid)
    {
        Actions.getSale(fillForm, servid);
    }

    function addPayment(servid)
    {
        Actions.getSale(fillPayment, servid);
    }

    function deleteSale(saleid)
    {
        if (confirm("Are you sure you want to delete this order?"))
        {
            Actions.deleteSale(loadStart, saleid);
        }
    }

    function writeSale()
    {
        Actions.writeSale(loadStart,
                          DWRUtil.getValue("saleid"),
                          DWRUtil.getValue("servid"),
                          DWRUtil.getValue("custid"),
                          DWRUtil.getValue("start_date"),
                          DWRUtil.getValue("price"),
                          DWRUtil.getValue("notes"));

        closeWindow("dwindow");
    }

    function cancelSale()
    {
        DWRUtil.setValue("saleid", "-1");
        DWRUtil.setValue("servid", "");
        DWRUtil.setValue("custid", "");
        DWRUtil.setValue("start_date", "");
        DWRUtil.setValue("price", "");
        DWRUtil.setValue("notes", "");

        closeWindow("dwindow");
    }

    function addSale()
    {
        DWRUtil.setValue("saleid", "-1");
        DWRUtil.setValue("servid", "");
        DWRUtil.setValue("custid", "");
        DWRUtil.setValue("start_date", "");
        DWRUtil.setValue("price", "");
        DWRUtil.setValue("notes", "");

        loadWindow("dwindow");
    }

    function fillForm(sale)
    {
        DWRUtil.setValue("saleid", sale.saleid);
        DWRUtil.setValue("servid", sale.servid);
        DWRUtil.setValue("custid", sale.custid);
        DWRUtil.setValue("start_date", sale.start_date);
        DWRUtil.setValue("price", sale.price);
        DWRUtil.setValue("notes", sale.notes);

        loadWindow("dwindow");
    }

    function fillPayment(sale)
    {
        var now = new Date();
        var paymentdate = now.getFullYear() + "-" + (now.getMonth()+1) + "-" + now.getDate();

        DWRUtil.setValue("paymentsaleid", sale.saleid);
        DWRUtil.setValue("paymentdate", paymentdate);
        DWRUtil.setValue("paymentamount", sale.price);
        DWRUtil.setValue("paymentmethod", "D");

        loadWindow("addPaymentWindow");
    }

    function cancelAddPayment()
    {
        closeWindow("addPaymentWindow");
    }

    function writeAddPayment()
    {
        Actions.writePayment(loadStart,
                          DWRUtil.getValue("paymentsaleid"),
                          DWRUtil.getValue("paymentdate"),
                          DWRUtil.getValue("paymentamount"),
                          DWRUtil.getValue("paymentmethod"));

        closeWindow("addPaymentWindow");
    }

    function init()
    {
        DWRUtil.useLoadingMessage();
        loadStart();
    }

    function loadStart()
    {
        Actions.getAllSales(fillTable);
        Actions.getAllCustomers(fillCustomers);
        Actions.getAllServices(fillServices);
    }

    function fillCustomers(data)
    {
        DWRUtil.removeAllOptions("custid");
        DWRUtil.addOptions("custid", data, "custid", "custname");
    }

    function fillServices(data)
    {
        DWRUtil.removeAllOptions("servid");
        DWRUtil.addOptions("servid", data, "servid", "servname");
    }

    callOnLoad(init);
  </script>
</head>

<body>
<iframe id="sidebar" src="sidebar.html" frameborder="0"></iframe>

<h1>Order Maintainence</h1>

<p>You will not be able to delete sales that are in use by customers.</p>

<input type="button" value="Add Sale" onclick="addSale()"/>
<br/><br/>

<table border="1" class="threed">
  <thead>
    <tr>
      <th>Customer</th>
      <th>Service</th>
      <th colspan="3">Actions</th>
    </tr>
  </thead>
  <tbody id="sales">
  </tbody>
</table>

<br/><br/>

<div id="dwindow" style="" class="window" onMousedown="initializeDrag('dwindow', event)" onMouseup="stopDrag('dwindow')" onSelectStart="return false;">
  <div class="titlebar">
    Add/Edit Sale <span class="quiet">(<span id="saleid">-1</span>)</span>
  </div>
  <div id="dwindowcontent">
    <table>
      <tr>
        <td>Customer:</td>
        <td><select id="custid" size="5"></select></td>
      </tr>
      <tr>
        <td>Service:</td>
        <td><select id="servid" size="5"></select></td>
      </tr>
      <tr>
        <td>Start Date:</td>
        <td>
          <input id="start_date" type="text" size="15"/> (YYYY-MM-DD)
          <!-- <form><script>DateInput('orderdate', true, 'YYYY-MM-DD')</script></form> -->
        </td>
      </tr>
      <tr>
        <td>Price:</td>
        <td><input id="price" type="text" size="10"/></td>
      </tr>
      <tr>
        <td>Notes:</td>
        <td><textarea id="notes" cols="30" rows="5"></textarea></td>
      </tr>
      <tr>
        <td colspan="2" align="right">
          <input type="button" value="Cancel" onclick="cancelSale()"/>
          <input type="button" value="Save" onclick="writeSale()"/>
        </td>
      </tr>
    </table>
  </div>
</div>

<div id="addPaymentWindow" style="" class="window" onMousedown="initializeDrag('addPaymentWindow', event)" onMouseup="stopDrag('addPaymentWindow')" onSelectStart="return false;">
  <div class="titlebar">
    Add Payment
  </div>
  <div id="addPaymentWindowContent">
    <input type="hidden" id="paymentsaleid"/>
    <table>
      <tr>
        <td>Date:</td>
        <td><input id="paymentdate" type="text" size="10"/> (YYYY-MM-DD)</td>
      </tr>
      <tr>
        <td>Amount:</td>
        <td><input id="paymentamount" type="text" size="10"/></td>
      </tr>
      <tr>
        <td>Method:</td>
        <td><input id="paymentmethod" type="text" size="10"/></td>
      </tr>
      <tr>
        <td colspan="2" align="right">
          <input type="button" value="Cancel" onclick="cancelAddPayment()"/>
          <input type="button" value="Save" onclick="writeAddPayment()"/>
        </td>
      </tr>
    </table>
  </div>
</div>

</body>
</html>
